<div class="form-container animate-fade-in">
  <div class="header-section">
    <h1 class="main-title">I'm listing my Hourly Room</h1>
    <h2 class="sub-title">I'm Owner</h2>
  </div>

  <form [formGroup]="listingForm">
    <div class="form-group">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Select City</mat-label>
        <img matPrefix src="/assets/images/icons/city_search.png" alt="City" class="city-search-icon" />
        <input
          matInput
          [matAutocomplete]="cityAuto"
          placeholder="Type to search cities"
          formControlName="cityControl"
          #cityAutoTrigger="matAutocompleteTrigger"
          (focus)="cityAutoTrigger.openPanel()"
        />
        <mat-autocomplete
          #cityAuto="matAutocomplete"
          [displayWith]="displayCityName"
          (optionSelected)="onCitySelected($event.option.value)"
        >
          <mat-option *ngFor="let city of filteredCities$ | async" [value]="city">
            {{ city.name }}
          </mat-option>
          <mat-option *ngIf="(filteredCities$ | async)?.length === 0" disabled>No cities found</mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </div>

    <div class="form-group">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Town & Sector</mat-label>
        <img matPrefix src="/assets/images/icons/icon_location.png" alt="Town and Sector" class="village-search-icon" />
        <input
          matInput
          [matAutocomplete]="townAuto"
          placeholder="Type to search town/sector"
          formControlName="townControl"
          #townAutoTrigger="matAutocompleteTrigger"
          (focus)="townAutoTrigger.openPanel()"
          [disabled]="!listingForm.get('city')?.value"
        />
        <mat-autocomplete #townAuto="matAutocomplete" (optionSelected)="onTownSelected($event.option.value)">
          <mat-option *ngIf="isLocationLoading$ | async" disabled>Loading locations...</mat-option>
          <mat-option *ngFor="let loc of filteredLocations$ | async" [value]="loc">
            {{ loc }}
          </mat-option>
          <mat-option
            *ngIf="!(locations$ | async)?.length && listingForm.get('city')?.value && !(isLocationLoading$ | async)"
            disabled
          >
            No locations found
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </div>

    <div class="form-row">
      <label class="form-label">Location</label>
      <input type="text" formControlName="location" class="form-control bg-light-blue">
    </div>

    <div class="form-row">
      <label class="form-label">Landmark</label>
      <input type="text" formControlName="landmark" class="form-control bg-light-blue">
    </div>

    <div class="form-row">
      <label class="form-label">Luxury</label>
      <input type="text" formControlName="luxury" class="form-control bg-light-blue">
    </div>

    <div class="form-row">
      <label class="form-label">Bedcount</label>
      <input type="number" formControlName="bedCount" class="form-control" appNumericOnly>
    </div>

    <div class="form-row">
      <label class="form-label">No of Guest Allowed</label>
      <input type="number" formControlName="guests" class="form-control" appNumericOnly>
    </div>

    <div class="form-row">
      <label class="form-label">Total Floors</label>
      <div class="input-with-artifact">
        <input type="number" formControlName="totalFloors" class="form-control border-thick" appNumericOnly>
        <div class="blue-arrow-artifact"></div>
      </div>
    </div>

    <div class="form-row">
      <label class="form-label">Minimum Price</label>
      <input type="number" formControlName="minPrice" class="form-control bg-light-blue" appNumericOnly>
    </div>

    <div class="form-row">
      <label class="form-label">Maximum Price</label>
      <input type="number" formControlName="maxPrice" class="form-control bg-light-blue" appNumericOnly>
    </div>

    <div class="form-row">
      <label class="form-label">Palace Name</label>
      <input type="text" formControlName="palaceName" placeholder="Enter palace name" class="form-control">
    </div>

    <div class="form-row">
      <label class="form-label">Total Room</label>
      <input type="number" formControlName="totalRoom" placeholder="Enter total room count" class="form-control" appNumericOnly>
    </div>

    <div class="form-row">
      <label class="form-label">Manager/Owner</label>
      <input type="text" formControlName="manager" placeholder="Enter manager/owner" class="form-control">
    </div>

    <div class="form-row">
      <label class="form-label">WhatsApp Number</label>
      <input
        type="number"
        formControlName="whatsappNo"
        placeholder="Enter whatsapp number"
        class="form-control"
        appNumericOnly
        [readonly]="contactOtpVerified"
        [class.readonly-input]="contactOtpVerified"
      >
    </div>

    <div class="mobile-extra">
      <div class="otp-cta">
        <div class="get-otp-div">
          <button
            *ngIf="!contactOtpVerified"
            type="button"
            class="otp-button"
            (click)="startContactOtpFlow()"
            [disabled]="(contactOtpRequested && !contactOtpVerified) || isSendingContactOtp || !isWhatsAppNumberValid"
          >
            <span *ngIf="!isSendingContactOtp">Send OTP</span>
            <mat-progress-spinner *ngIf="isSendingContactOtp" diameter="18" mode="indeterminate"></mat-progress-spinner>
          </button>
          <small
            *ngIf="showContactOtpSentMessage && contactOtpRequested && !contactOtpVerified"
            style="display:block;margin-top:4px"
          >
            OTP sent successfully <i class="fas fa-check-circle" style="color: rgb(3, 152, 3);"></i>
          </small>
        </div>
      </div>
      <div *ngIf="contactOtpRequested" class="otp-panel">
        <div class="otp-block">
          <input
            id="contact-otp"
            type="tel"
            maxlength="6"
            [(ngModel)]="contactOtpInput"
            [ngModelOptions]="{ standalone: true }"
            placeholder="XXXXXX"
            name="contactOtp"
            class="form-control otp-input"
          />
        </div>
        <div *ngIf="contactOtpError" class="validation-error" style="margin-top:6px;">
          <span><small style="color: red;">{{ contactOtpError }}</small></span>
          <button
            *ngIf="showContactResendOption"
            type="button"
            class="resend-link"
            (click)="resendContactOtp()"
          >
            Resend OTP
          </button>
        </div>
        <div class="otp-block">
          <button type="button" class="otp-verify-button" (click)="verifyContactOtp()">
            <span *ngIf="!isVerifyingContactOtp">Verify OTP</span>
            <mat-progress-spinner *ngIf="isVerifyingContactOtp" diameter="18" mode="indeterminate"></mat-progress-spinner>
          </button>
        </div>
      </div>
    </div>

    <div class="form-row align-start">
      <label class="form-label pt-2">Full Address</label>
      <textarea formControlName="address" placeholder="Enter full address" rows="4" class="form-control"></textarea>
    </div>

    <div class="radio-section">
      <h3 class="section-title">Furnishing Type *</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="radio" value="Fully furnished" formControlName="furnishing"><span>Fully furnished</span></label>
        <label class="radio-item"><input type="radio" value="Semi furnished" formControlName="furnishing"><span>Semi furnished</span></label>
        <label class="radio-item"><input type="radio" value="Unfurnished" formControlName="furnishing"><span>Unfurnished</span></label>
      </div>
    </div>

    <div class="radio-section">
      <h3 class="section-title">Accommodation Type</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="radio" value="Independent" formControlName="accommodation"><span>Independent</span></label>
        <label class="radio-item"><input type="radio" value="Apartment" formControlName="accommodation"><span>Apartment</span></label>
      </div>
    </div>

    <!-- Pets Allowed removed for hourly room listings -->

    <div class="radio-section">
      <h3 class="section-title">Gender Preferences</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="radio" value="Male" formControlName="gender"><span>Male</span></label>
        <label class="radio-item"><input type="radio" value="Female" formControlName="gender"><span>Female</span></label>
        <label class="radio-item"><input type="radio" value="Both M &amp; F" formControlName="gender"><span>Both M &amp; F</span></label>
      </div>
    </div>

    <div class="radio-section">
      <h3 class="section-title">Food Availability</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="radio" value="Yes" formControlName="food"><span>Yes</span></label>
        <label class="radio-item"><input type="radio" value="No" formControlName="food"><span>No</span></label>
      </div>
    </div>

    <div class="radio-section">
      <h3 class="section-title">Room Type</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="radio" value="Shared Room" formControlName="roomType1"><span>Shared Room</span></label>
        <label class="radio-item"><input type="radio" value="Private Room" formControlName="roomType1"><span>Private Room</span></label>
      </div>
    </div>

    <div class="radio-section">
      <h3 class="section-title">AC Type</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="radio" value="AC" formControlName="roomType2"><span>AC</span></label>
        <label class="radio-item"><input type="radio" value="Non AC" formControlName="roomType2"><span>Non AC</span></label>
      </div>
    </div>

    <div class="radio-section" formGroupName="parking">
      <h3 class="section-title">Parking</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="checkbox" formControlName="car"><span>Car</span></label>
        <label class="radio-item"><input type="checkbox" formControlName="bike"><span>Bike</span></label>
      </div>
    </div>

    <div class="radio-section" formGroupName="preferTenant">
      <h3 class="section-title">Prefer Tenant Type</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="checkbox" formControlName="family"><span>Family</span></label>
        <label class="radio-item"><input type="checkbox" formControlName="bachelors"><span>Bachelors</span></label>
        <label class="radio-item"><input type="checkbox" formControlName="girls"><span>Girls</span></label>
        <label class="radio-item"><input type="checkbox" formControlName="boys"><span>Boys</span></label>
        <label class="radio-item"><input type="checkbox" formControlName="professionals"><span>Professionals</span></label>
      </div>
    </div>

    <div class="radio-section" formGroupName="insideFacility">
      <h3 class="section-title">Room Inside Facility</h3>
      <div class="radio-group">
        <label class="radio-item" *ngFor="let facility of insideFacilities">
          <input type="checkbox" [formControlName]="facility.key">
          <span>{{ facility.label }}</span>
        </label>
      </div>
    </div>

    <div class="radio-section" formGroupName="outsideFacility">
      <h3 class="section-title">Room Outside Facility</h3>
      <div class="radio-group">
        <label class="radio-item" *ngFor="let facility of outsideFacilities">
          <input type="checkbox" [formControlName]="facility.key">
          <span>{{ facility.label }}</span>
        </label>
      </div>
    </div>

    <div class="button-group">
      <button type="button" (click)="onNext()" class="btn btn-next" [disabled]="listingForm.invalid || isSaving">
        <span *ngIf="!isSaving">Next</span>
        <mat-progress-spinner
          *ngIf="isSaving"
          color="accent"
          diameter="18"
          mode="indeterminate"
        ></mat-progress-spinner>
      </button>
      <button type="button" (click)="onCancel()" class="btn btn-cancel">Cancel</button>
    </div>
    <div *ngIf="showCancelConfirmation" class="cancel-toast">
      <span>Do you Really want to cancel submission of this form?</span>
      <div class="toast-actions">
        <button type="button" class="toast-btn" (click)="confirmCancel()">Yes</button>
        <button type="button" class="toast-btn ghost" (click)="dismissCancelConfirmation()">No</button>
      </div>
    </div>
    <div *ngIf="showOtpDialog" class="token-dialog-backdrop">
      <div class="token-dialog">
        <p>{{ otpDialogMessage }}</p>
        <button type="button" class="token-dialog-btn" (click)="closeOtpDialog()">OK</button>
      </div>
    </div>
  </form>
</div>
