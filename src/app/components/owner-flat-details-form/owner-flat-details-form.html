<div class="form-container animate-fade-in">
  <!-- Loading Overlay -->
  <div *ngIf="isSaving" class="loading-overlay">
    <mat-progress-spinner diameter="48" mode="indeterminate"></mat-progress-spinner>
    <span class="loading-text">Creating listing...</span>
  </div>

  <div class="header-section">
    <h1 class="main-title">I'm listing my Flat</h1>
    <a href="#"><h2 class="sub-title" >Show listing Sample</h2></a>
  </div>

  <form [formGroup]="listingForm">
    <div class="form-group">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Select City</mat-label>
        <img matPrefix src="/assets/images/icons/city_search.png" alt="City" class="city-search-icon" />
        <input
          matInput
          [matAutocomplete]="cityAuto"
          placeholder="Type to search cities"
          formControlName="cityControl"
          #cityAutoTrigger="matAutocompleteTrigger"
          (focus)="cityAutoTrigger.openPanel()"
        />
        <mat-autocomplete
          #cityAuto="matAutocomplete"
          [displayWith]="displayCityName"
          (optionSelected)="onCitySelected($event.option.value)"
        >
          <mat-option *ngFor="let city of filteredCities$ | async" [value]="city">
            {{ city.name }}
          </mat-option>
          <mat-option *ngIf="(filteredCities$ | async)?.length === 0" disabled>No cities found</mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </div>

    <div class="form-group">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Town & Sector</mat-label>
        <img matPrefix src="/assets/images/icons/icon_location.png" alt="Town and Sector" class="village-search-icon" />
        <input
          matInput
          [matAutocomplete]="townAuto"
          placeholder="Type to search town/sector"
          formControlName="townControl"
          #townAutoTrigger="matAutocompleteTrigger"
          (focus)="townAutoTrigger.openPanel()"
          [disabled]="!listingForm.get('city')?.value"
        />
        <mat-autocomplete #townAuto="matAutocomplete" (optionSelected)="onTownSelected($event.option.value)">
          <mat-option *ngIf="isLocationLoading$ | async" disabled>Loading locations...</mat-option>
          <mat-option *ngFor="let loc of filteredLocations$ | async" [value]="loc">
            {{ loc }}
          </mat-option>
          <mat-option
            *ngIf="!(locations$ | async)?.length && listingForm.get('city')?.value && !(isLocationLoading$ | async)"
            disabled
          >
            No locations found
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </div>

    <div class="form-row">
      <label class="form-label">Area/Colony</label>
      <input type="text" formControlName="location" placeholder="Enter area/colony" class="form-control bg-light-blue">
    </div>

    <div class="form-row">
      <label class="form-label">Landmark</label>
      <input type="text" formControlName="landmark" placeholder="Enter landmark" class="form-control bg-light-blue">
    </div>

    <div class="form-row">
      <label class="form-label">Minimum Price per Month</label>
      <input type="number" formControlName="minPrice" placeholder="Enter min price per month" class="form-control bg-light-blue" appNumericOnly>
    </div>

    <div class="form-row">
      <label class="form-label">Maximum Price per Month</label>
      <input type="number" formControlName="maxPrice" placeholder="Enter max price per month" class="form-control bg-light-blue" appNumericOnly>
    </div>
    

    <!-- <div class="form-row">
      <label class="form-label">BHK Type</label>
      <select formControlName="bhk" class="form-control" title="Select BHK Type">
        <option value="1 RK">1 RK</option>
        <option value="1 BHK">1 BHK</option>
        <option value="2 BHK">2 BHK</option>
        <option value="3 BHK">3 BHK</option>
        <option value="4 BHK">4 BHK</option>
        <option value="4+ BHK">4+ BHK</option>
      </select>
    </div> -->

    <div class="form-row">
      <label class="form-label">Security Deposit</label>
      <input type="number" formControlName="security" placeholder="Enter security amount" class="form-control" appNumericOnly>
    </div>

    <div class="form-row">
      <label class="form-label">Maintenance</label>
      <input type="number" formControlName="maintenance" placeholder="Enter maintenance" class="form-control" appNumericOnly>
    </div>

    <div class="form-row">
      <label class="form-label">Total Floors</label>
      <input type="number" formControlName="totalFloors" placeholder="Enter total floors" class="form-control" appNumericOnly>
    </div>

    <div class="form-row">
      <label class="form-label">Total Flat</label>
      <input type="number" formControlName="totalFlat" placeholder="Enter total flats" class="form-control" appNumericOnly>
    </div>

     <div class="form-row">
      <label class="form-label">Water Supply in Hours</label>
      <input type="number" formControlName="waterSupply" placeholder="Enter water supply in hours" class="form-control" appNumericOnly>
    </div>

    <div class="form-row">
      <label class="form-label">Power Backup in hours </label>
      <input type="number" formControlName="powerBackup" placeholder="Enter power backup in hours" class="form-control" appNumericOnly>
    </div>

     <div class="form-row">
      <label class="form-label">Notice Period</label>
      <input type="number" formControlName="noticePeriod" placeholder="Enter notice period" class="form-control" appNumericOnly>
    </div>


    <div class="form-row">
      <label class="form-label">Offer if any</label>
      <input type="text" formControlName="offer" placeholder="Enter offer if any" class="form-control">
    </div>

    <div class="form-row">
      <label class="form-label">Whatsapp No</label>
      <input
        type="number"
        formControlName="whatsappNo"
        placeholder="Enter whatsapp number"
        class="form-control"
        appNumericOnly
        [readonly]="contactOtpVerified"
        [class.readonly-input]="contactOtpVerified"
      >
    </div>
    <div class="mobile-extra">
      <div class="otp-cta">
        <div class="get-otp-div">
          <button
            *ngIf="!contactOtpVerified"
            type="button"
            class="otp-button"
            (click)="startContactOtpFlow()"
            [disabled]="(contactOtpRequested && !contactOtpVerified) || isSendingContactOtp || !isContactNumberValid"
          >
            <span *ngIf="!isSendingContactOtp">Send OTP</span>
            <mat-progress-spinner *ngIf="isSendingContactOtp" diameter="18" mode="indeterminate"></mat-progress-spinner>
          </button>
          <small
            *ngIf="showContactOtpSentMessage && contactOtpRequested && !contactOtpVerified"
            style="display:block;margin-top:4px"
          >
            OTP sent successfully <i class="fas fa-check-circle" style="color: rgb(3, 152, 3);"></i>
          </small>
        </div>
      </div>
      <div *ngIf="contactOtpRequested" class="otp-panel">
        <div class="otp-block">
          <input
            id="contact-otp"
            type="tel"
            maxlength="6"
            [(ngModel)]="contactOtpInput"
            [ngModelOptions]="{ standalone: true }"
            placeholder="XXXXXX"
            name="contactOtp"
            class="form-control otp-input"
          />
        </div>
        <div *ngIf="contactOtpError" class="validation-error" style="margin-top:6px">
          <span><small style="color: red;">{{ contactOtpError }}</small></span>
          <button
            *ngIf="showContactResendOption"
            type="button"
            class="resend-link"
            (click)="resendContactOtp()"
          >
            Resend OTP
          </button>
        </div>
        <div class="otp-block">
          <button type="button" class="otp-verify-button" (click)="verifyContactOtp()">
            <span *ngIf="!isVerifyingContactOtp">Verify OTP</span>
            <mat-progress-spinner *ngIf="isVerifyingContactOtp" diameter="18" mode="indeterminate"></mat-progress-spinner>
          </button>
        </div>
      </div>
    </div>
  
 <div class="form-row">
      <label class="form-label">Contact Name</label>
      <input type="text" formControlName="contact" placeholder="Enter contact name" class="form-control">
    </div>

  
    <div class="form-row">
      <label class="form-label">BHK</label>
      <input type="text" formControlName="bhk" placeholder="Select BHK" class="form-control bg-light-blue">
    </div>

    

    <div class="form-row">
      <label class="form-label">Manager/Owner</label>
      <input type="text" formControlName="manager" placeholder="Enter manager/owner name" class="form-control">
    </div>

   

    <div class="form-row align-start">
      <label class="form-label pt-2">Full Address</label>
      <textarea formControlName="address" placeholder="Enter full address" rows="4" class="form-control"></textarea>
    </div>

    <div class="radio-section">
      <h3 class="section-title">Furnishing Type *</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="radio" value="Fully furnished" formControlName="furnishing"><span>Fully furnished</span></label>
        <label class="radio-item"><input type="radio" value="Semi furnished" formControlName="furnishing"><span>Semi furnished</span></label>
        <label class="radio-item"><input type="radio" value="Unfurnished" formControlName="furnishing"><span>Unfurnished</span></label>
      </div>
    </div>

    <div class="radio-section">
      <h3 class="section-title">Accommodation Type</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="radio" value="Independent" formControlName="accommodation"><span>Independent</span></label>
        <label class="radio-item"><input type="radio" value="Apartment" formControlName="accommodation"><span>Apartment</span></label>
        <label class="radio-item"><input type="radio" value="Builder Floor" formControlName="accommodation"><span>Builder Floor</span></label>
      </div>
    </div>

    <div class="radio-section">
      <h3 class="section-title">Pets Allowed</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="radio" value="Yes" formControlName="petAllowed"><span>Yes</span></label>
        <label class="radio-item"><input type="radio" value="No" formControlName="petAllowed"><span>No</span></label>
      </div>
    </div>

    <div class="radio-section">
      <h3 class="section-title">Gender Preferences</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="radio" value="Male" formControlName="gender"><span>Male</span></label>
        <label class="radio-item"><input type="radio" value="Female" formControlName="gender"><span>Female</span></label>
        <label class="radio-item"><input type="radio" value="Both M &amp; F" formControlName="gender"><span>Both M &amp; F</span></label>
        <label class="radio-item"><input type="radio" value="Any" formControlName="gender"><span>Any</span></label>
      </div>
    </div>

    

    <div class="radio-section">
      <h3 class="section-title">Flat Type</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="radio" value="Private" formControlName="flatType"><span>Private</span></label>
        <label class="radio-item"><input type="radio" value="Shared" formControlName="flatType"><span>Shared</span></label>
      </div>
    </div>

    <div class="radio-section" formGroupName="parking">
      <h3 class="section-title">Parking</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="checkbox" formControlName="car"><span>Car</span></label>
        <label class="radio-item"><input type="checkbox" formControlName="bike"><span>Bike</span></label>
      </div>
    </div>

    <div class="radio-section" formGroupName="preferTenant">
      <h3 class="section-title">Prefer Tenant Type</h3>
      <div class="radio-group">
        <label class="radio-item"><input type="checkbox" formControlName="family"><span>Family</span></label>
        <label class="radio-item"><input type="checkbox" formControlName="bachelors"><span>Bachelors</span></label>
        <label class="radio-item"><input type="checkbox" formControlName="girls"><span>Girls</span></label>
        <label class="radio-item"><input type="checkbox" formControlName="boys"><span>Boys</span></label>
        <label class="radio-item"><input type="checkbox" formControlName="professionals"><span>Professionals</span></label>
      </div>
    </div>

    <div class="radio-section" formGroupName="insideFacility">
      <h3 class="section-title">Flat Inside Facility</h3>
      <div class="radio-group">
        <label class="radio-item" *ngFor="let facility of insideFacilities">
          <input type="checkbox" [formControlName]="facility.key">
          <span>{{ facility.label }}</span>
        </label>
      </div>
    </div>

    <div class="radio-section" formGroupName="outsideFacility">
      <h3 class="section-title">Flat Outside Facility</h3>
      <div class="radio-group">
        <label class="radio-item" *ngFor="let facility of outsideFacilities">
          <input type="checkbox" [formControlName]="facility.key">
          <span>{{ facility.label }}</span>
        </label>
      </div>
    </div>

    <div class="button-group">
      <button type="button" (click)="onNext()" class="btn btn-next" [disabled]="listingForm.invalid">Next</button>
      <button type="button" (click)="onCancel()" class="btn btn-cancel">Cancel</button>
    </div>
    <div *ngIf="showCancelConfirmation" class="cancel-toast">
      <span>Do you Really want to cancel submission of this form?</span>
      <div class="toast-actions">
        <button type="button" class="toast-btn" (click)="confirmCancel()">Yes</button>
        <button type="button" class="toast-btn ghost" (click)="dismissCancelConfirmation()">No</button>
      </div>
    </div>
    <div *ngIf="showOtpDialog" class="token-dialog-backdrop">
      <div class="token-dialog">
        <h2>www.roomlocus.com says</h2>
        <p>{{ otpDialogMessage }}</p>
        <button type="button" class="token-dialog-btn" (click)="closeOtpDialog()">OK</button>
      </div>
    </div>
  </form>
</div>
