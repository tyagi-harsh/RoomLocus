<div class="home-container">
  <div class="city-carousel-wrapper">
    <owl-carousel-o [options]="carouselOptions" *ngIf="cities$ | async as cities">
      <ng-container *ngFor="let city of cities">
        <ng-template carouselSlide>
          <mat-card class="city-card">
            <img mat-card-image [src]="city.imageUrl" [alt]="city.name" />
            <div class="city-name">{{ city.name }}</div>
          </mat-card>
        </ng-template>
      </ng-container>
    </owl-carousel-o>
  </div>

  <mat-card class="search-form-card">
    <!-- Debug panel: shows last /townSector request & response for troubleshooting
    <div class="debug-panel" style="padding:8px; background:#fff8c6; border:1px solid #f0e68c; margin:8px 0;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <div style="font-weight:600;">Debug â€” last townSector request</div>
        <button mat-stroked-button color="warn" (click)="clearLocationCache()" style="padding:0 8px;">
          Clear cache
        </button>
      </div>
      <div style="font-size:12px; color:#333; word-break:break-all;">
        URL:
        <span *ngIf="lastLocationsRequest$ | async as req; else noReq">{{ req }}</span>
        <ng-template #noReq>n/a</ng-template>
      </div>

      <div style="margin-top:6px; font-weight:600;">Parsed response:</div>

      <div style="font-size:12px; color:#333; white-space:pre-wrap; max-height:120px; overflow:auto;">
        {{ (lastLocationsResponse$ | async) | json }}
      </div>
    </div> -->

    <div class="for-rent-toggle">
      <button mat-flat-button color="primary" class="for-rent-button">For Rent</button>
    </div>

    <form [formGroup]="searchForm" (ngSubmit)="onSearch()" class="search-form">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Looking for</mat-label>
        <img matPrefix src="/assets/images/icons/looking_for_search_bar.png" alt="Looking for"
          class="looking-for-icon" />
        <mat-select formControlName="lookingFor" yPosition="below">
          <ng-container *ngIf="lookingForOptions$ | async as options; else spinnerTemplate">
            <mat-option *ngFor="let option of options" [value]="option">
              {{ option }}
            </mat-option>
          </ng-container>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Select City</mat-label>
        <img matPrefix src="/assets/images/icons/city_search.png" alt="City" class="city-search-icon" />
        <input
          matInput
          formControlName="city"
          (focus)="onCityInputFocus(); cityTrigger.openPanel()"
          (input)="onCityFilter($event.target.value)"
          [matAutocomplete]="cityAutocomplete"
          #cityTrigger="matAutocompleteTrigger"
          matAutocompleteTrigger
        />
        <mat-autocomplete
          #cityAutocomplete="matAutocomplete"
          (optionSelected)="onCitySelected($event)"
          [displayWith]="displayCityName"
          autoActiveFirstOption
        >
          <mat-option *ngIf="(filteredCities$ | async)?.length === 0" disabled>
            No cities match your search
          </mat-option>
          <mat-option *ngFor="let city of filteredCities$ | async" [value]="city.id">
            {{ city.name }}
          </mat-option>
        </mat-autocomplete>
        <mat-error *ngIf="searchForm.get('city')?.touched && searchForm.get('city')?.hasError('required')">
          Please select a city
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Village & Sector</mat-label>
        <img matPrefix src="/assets/images/icons/icon_location.png" alt="Village and Sector"
          class="village-search-icon" />
        <input
          matInput
          formControlName="location"
          [matAutocomplete]="locationAutocomplete"
          (focus)="onLocationDropdownOpened(true); locationTrigger.openPanel()"
          (input)="onLocationFilter($event.target.value)"
          #locationTrigger="matAutocompleteTrigger"
          matAutocompleteTrigger
        />
        <mat-autocomplete #locationAutocomplete="matAutocomplete" autoActiveFirstOption>
          <ng-container *ngIf="isLocationLoading$ | async; else locationLoaded">
            <mat-option disabled>
              Loading locations...
            </mat-option>
          </ng-container>
          <ng-template #locationLoaded>
            <ng-container *ngIf="searchForm.get('city')?.value && searchForm.get('lookingFor')?.value; else selectCityType">
              <ng-container *ngIf="filteredLocations$ | async as locations">
                <mat-option *ngIf="locations.length === 0" disabled>
                  No locations found for selected city
                </mat-option>
                <mat-option *ngFor="let loc of locations" [value]="loc">
                  {{ loc }}
                </mat-option>
              </ng-container>
            </ng-container>
          </ng-template>
          <ng-template #selectCityType>
            <mat-option disabled>
              Please select city & property type first
            </mat-option>
          </ng-template>
        </mat-autocomplete>
        <mat-error *ngIf="
            searchForm.get('location')?.touched && searchForm.get('location')?.hasError('required')
          ">
          Please select a location
        </mat-error>
      </mat-form-field>

      <button mat-flat-button color="accent" type="submit" class="search-button">
        Let's Search..
      </button>
    </form>

    <ng-template #spinnerTemplate>
      <div class="spinner-container">
        <mat-spinner diameter="30"></mat-spinner>
      </div>
    </ng-template>

    <div class="action-buttons">
      <button mat-flat-button color="primary" class="near-me-button">
        <img src="/assets/images/icons/near_me.png" alt="Near Me" class="near-me-icon" />Near Me
      </button>
      <button mat-flat-button color="primary" class="add-rental-button" (click)="onAddRentalClick()">
        <img src="/assets/images/icons/add_rental_2.png" alt="Add Rental" class="add-rental-icon" />
        Add Rental Free >
      </button>
    </div>
  </mat-card>

  <div class="tagline">
    <h3>India's Largest Room Collection</h3>
    <p>Trust on Verified Room</p>
  </div>
</div>