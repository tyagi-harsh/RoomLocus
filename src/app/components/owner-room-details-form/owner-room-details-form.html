<div class="form-container animate-fade-in">
	<div *ngIf="isSaving" class="loading-overlay">
		<mat-progress-spinner diameter="48" mode="indeterminate"></mat-progress-spinner>
		<span class="loading-text">Creating listing...</span>
	</div>

	<div class="header-section">
		<h1 class="main-title">I'm listing my Room</h1>
		<a href="#"><h2 class="sub-title">Show listing Sample</h2></a>
	</div>

	<form [formGroup]="listingForm" class="room-form">
		<section class="section-grid">
			<mat-form-field appearance="outline" class="full-width">
				<mat-label class="required">Select City</mat-label>
				<img matPrefix src="/assets/images/icons/city_search.png" alt="City" class="city-search-icon" />
				<input
					matInput
					[matAutocomplete]="cityAuto"
					placeholder="Type to search cities"
					formControlName="cityControl"
					#cityAutoTrigger="matAutocompleteTrigger"
					(focus)="cityAutoTrigger.openPanel()"
				/>
				<mat-autocomplete
					#cityAuto="matAutocomplete"
					[displayWith]="displayCityName"
					(optionSelected)="onCitySelected($event.option.value)"
				>
					<mat-option *ngFor="let city of filteredCities$ | async" [value]="city">
						{{ city.name }}
					</mat-option>
					<mat-option *ngIf="(filteredCities$ | async)?.length === 0" disabled>No cities found</mat-option>
				</mat-autocomplete>
				<mat-error *ngIf="listingForm.get('cityControl')?.hasError('required') && (listingForm.get('cityControl')?.dirty || listingForm.get('cityControl')?.touched)">
					City is required.
				</mat-error>
			</mat-form-field>

			<mat-form-field appearance="outline" class="full-width">
				<mat-label class="required">Town &amp; Sector</mat-label>
				<img matPrefix src="/assets/images/icons/icon_location.png" alt="Town and Sector" class="village-search-icon" />
				<input
					matInput
					[matAutocomplete]="townAuto"
					placeholder="Type to search town/sector"
					formControlName="townControl"
					#townAutoTrigger="matAutocompleteTrigger"
					(focus)="townAutoTrigger.openPanel()"
					[disabled]="!listingForm.get('city')?.value"
				/>
				<mat-autocomplete #townAuto="matAutocomplete" (optionSelected)="onTownSelected($event.option.value)">
					<mat-option *ngIf="isLocationLoading$ | async" disabled>Loading locations...</mat-option>
					<mat-option *ngFor="let loc of filteredLocations$ | async" [value]="loc">
						{{ loc }}
					</mat-option>
					<mat-option
						*ngIf="!(locations$ | async)?.length && listingForm.get('city')?.value && !(isLocationLoading$ | async)"
						disabled
					>
						No locations found
					</mat-option>
				</mat-autocomplete>
				<mat-error *ngIf="listingForm.get('townControl')?.hasError('required') && (listingForm.get('townControl')?.dirty || listingForm.get('townControl')?.touched)">
					Town/Sector is required.
				</mat-error>
			</mat-form-field>
		</section>

		<section class="section-grid">
			<div class="form-row">
				<label class="form-label required">Area/Colony</label>
				<input type="text" formControlName="location" placeholder="Enter area/colony" class="form-control bg-light-blue" />
				<div class="validation-error" *ngIf="listingForm.get('location')?.hasError('required') && (listingForm.get('location')?.dirty || listingForm.get('location')?.touched)">
					<small>Area/Colony is required.</small>
				</div>
			</div>
			<div class="form-row">
				<label class="form-label required">Landmark</label>
				<input type="text" formControlName="landmark" placeholder="Enter landmark" class="form-control bg-light-blue" />
				<div class="validation-error" *ngIf="listingForm.get('landmark')?.hasError('required') && (listingForm.get('landmark')?.dirty || listingForm.get('landmark')?.touched)">
					<small>Landmark is required.</small>
				</div>
			</div>
		</section>

		

		<section class="section-grid">
			<div class="form-row">
				<label class="form-label required">Min Price</label>
				<input type="number" formControlName="minPrice" placeholder="Enter min price" class="form-control" appNumericOnly />
				<div class="validation-error" *ngIf="listingForm.get('minPrice')?.hasError('required') && (listingForm.get('minPrice')?.dirty || listingForm.get('minPrice')?.touched)">
					<small>Minimum price is required.</small>
				</div>
			</div>
			<div class="form-row">
				<label class="form-label required">Max Price</label>
				<input type="number" formControlName="maxPrice" placeholder="Enter max price" class="form-control" appNumericOnly />
				<div class="validation-error" *ngIf="listingForm.get('maxPrice')?.hasError('required') && (listingForm.get('maxPrice')?.dirty || listingForm.get('maxPrice')?.touched)">
					<small>Maximum price is required.</small>
				</div>
			</div>
		</section>

		<section class="section-grid">
			<div class="form-row">
				<label class="form-label required">Maintenance</label>
				<input type="number" formControlName="maintenance" placeholder="Enter maintenance" class="form-control" appNumericOnly />
				<div class="validation-error" *ngIf="listingForm.get('maintenance')?.hasError('required') && (listingForm.get('maintenance')?.dirty || listingForm.get('maintenance')?.touched)">
					<small>Maintenance is required.</small>
				</div>
			</div>
			<div class="form-row">
				<label class="form-label required">Security Deposit</label>
				<input type="number" formControlName="security" placeholder="Enter security amount" class="form-control" appNumericOnly />
				<div class="validation-error" *ngIf="listingForm.get('security')?.hasError('required') && (listingForm.get('security')?.dirty || listingForm.get('security')?.touched)">
					<small>Security deposit is required.</small>
				</div>
			</div>
		</section>

		<section class="section-grid">
			<div class="form-row">
				<label class="form-label required">Notice Period</label>
				<input type="number" formControlName="noticePeriod" placeholder="Enter notice period" class="form-control" appNumericOnly />
				<div class="validation-error" *ngIf="listingForm.get('noticePeriod')?.hasError('required') && (listingForm.get('noticePeriod')?.dirty || listingForm.get('noticePeriod')?.touched)">
					<small>Notice period is required.</small>
				</div>
			</div>
			<div class="form-row">
				<label class="form-label">Offer if any</label>
				<input type="text" formControlName="offer" placeholder="Enter offer if any" class="form-control" />
			</div>
		</section>

		<section class="section-grid">
			<div class="form-row">
				<label class="form-label">Total Floors</label>
				<input type="number" formControlName="totalFloors" placeholder="Enter total floors" class="form-control" appNumericOnly />
			</div>
			<div class="form-row">
				<label class="form-label">Total Rooms</label>
				<input type="number" formControlName="totalRoom" placeholder="Enter total rooms" class="form-control" appNumericOnly />
			</div>
		</section>

		<section class="section-grid">
			<div class="form-row">
				<label class="form-label required">Water Supply (hrs)</label>
				<input type="number" formControlName="waterSupply" placeholder="Enter water supply" class="form-control" appNumericOnly />
				<div class="validation-error" *ngIf="listingForm.get('waterSupply')?.invalid && (listingForm.get('waterSupply')?.dirty || listingForm.get('waterSupply')?.touched)">
					<small *ngIf="listingForm.get('waterSupply')?.hasError('required')">Water supply is required.</small>
					<small *ngIf="listingForm.get('waterSupply')?.hasError('max')">Water supply cannot exceed 24 hours.</small>
				</div>
			</div>
			<div class="form-row">
				<label class="form-label required">Power Backup (hrs)</label>
				<input type="number" formControlName="powerBackup" placeholder="Enter power backup" class="form-control" appNumericOnly />
				<div class="validation-error" *ngIf="listingForm.get('powerBackup')?.invalid && (listingForm.get('powerBackup')?.dirty || listingForm.get('powerBackup')?.touched)">
					<small *ngIf="listingForm.get('powerBackup')?.hasError('required')">Power backup is required.</small>
					<small *ngIf="listingForm.get('powerBackup')?.hasError('max')">Power backup cannot exceed 24 hours.</small>
				</div>
			</div>
		</section>

		<section class="section-grid">
			<div class="form-row">
				<label class="form-label required">Contact Number</label>
				<div class="input-with-indicator">
					<input
						type="number"
						formControlName="contact"
						placeholder="Enter contact number"
						class="form-control"
						appNumericOnly
						[readonly]="contactOtpVerified"
						[class.readonly-input]="contactOtpVerified"
					/>
					<span class="verified-indicator" *ngIf="contactOtpVerified" aria-hidden="true">
						<i class="fas fa-check-circle"></i>
					</span>
				</div>
				<div
					class="validation-error"
					*ngIf="listingForm.get('contact')?.invalid && (listingForm.get('contact')?.dirty || listingForm.get('contact')?.touched)">
					<small *ngIf="listingForm.get('contact')?.hasError('required')">Contact number is required.</small>
					<small *ngIf="listingForm.get('contact')?.hasError('pattern')">Enter a 10-digit mobile number starting with 6-9.</small>
				</div>
			</div>
			<div class="form-row">
				<label class="form-label required">Contact Name</label>
				<input type="text" formControlName="contactName" placeholder="Enter contact name" class="form-control" />
				<div class="validation-error" *ngIf="listingForm.get('contactName')?.hasError('required') && (listingForm.get('contactName')?.dirty || listingForm.get('contactName')?.touched)">
					<small>Contact name is required.</small>
				</div>
			</div>
		</section>

		<section class="mobile-extra">
			<div class="otp-cta">
				<button
					*ngIf="!contactOtpVerified"
					type="button"
					class="otp-button"
					(click)="startContactOtpFlow()"
					[disabled]="(contactOtpRequested && !contactOtpVerified) || isSendingContactOtp || !isContactNumberValid"
				>
					<span *ngIf="!isSendingContactOtp">Send OTP</span>
					<mat-progress-spinner *ngIf="isSendingContactOtp" diameter="18" mode="indeterminate"></mat-progress-spinner>
				</button>
				<small *ngIf="showContactOtpSentMessage && contactOtpRequested && !contactOtpVerified" class="otp-feedback">
					OTP sent successfully <i class="fas fa-check-circle" style="color: rgb(3, 152, 3);"></i>
				</small>
			</div>
			<div *ngIf="contactOtpRequested" class="otp-panel">
				<div class="otp-block">
					<input
						id="contact-otp"
						type="tel"
						maxlength="6"
						[(ngModel)]="contactOtpInput"
						[ngModelOptions]="{ standalone: true }"
						placeholder="XXXXXX"
						name="contactOtp"
						class="form-control otp-input"
					/>
				</div>
				<div *ngIf="contactOtpError" class="validation-error" style="margin-top:6px;">
					<span><small style="color: red;">{{ contactOtpError }}</small></span>
					<button *ngIf="showContactResendOption" type="button" class="resend-link" (click)="resendContactOtp()">
						Resend OTP
					</button>
				</div>
				<div class="otp-block">
					<button type="button" class="otp-verify-button" (click)="verifyContactOtp()">
						<span *ngIf="!isVerifyingContactOtp">Verify OTP</span>
						<mat-progress-spinner *ngIf="isVerifyingContactOtp" diameter="18" mode="indeterminate"></mat-progress-spinner>
					</button>
				</div>
			</div>
		</section>

		<section class="section-grid">
			<div class="form-row">
				<label class="form-label required">BHK</label>
				<select formControlName="bhk" class="form-control bg-light-blue" title="Select BHK">
					<option value="">Select BHK</option>
					<option value="1 BHK">1 BHK</option>
					<option value="2 BHK">2 BHK</option>
					<option value="3 BHK">3 BHK</option>
					<option value="4 BHK">4 BHK</option>
					<option value="Other">Other</option>
				</select>
				<div class="validation-error" *ngIf="listingForm.get('bhk')?.hasError('required') && (listingForm.get('bhk')?.dirty || listingForm.get('bhk')?.touched)">
					<small>BHK selection is required.</small>
				</div>
			</div>
			<div class="form-row">
				<label class="form-label required">Manager/Owner</label>
				<input type="text" formControlName="manager" placeholder="Enter manager/owner name" class="form-control" />
				<div class="validation-error" *ngIf="listingForm.get('manager')?.hasError('required') && (listingForm.get('manager')?.dirty || listingForm.get('manager')?.touched)">
					<small>Manager or owner name is required.</small>
				</div>
			</div>
		</section>

<div class="form-row align-start">
      <label class="form-label required pt-2">Full Address</label>
      <textarea formControlName="address" placeholder="Enter full address" rows="4" class="form-control"></textarea>
      <div class="validation-error" *ngIf="listingForm.get('address')?.hasError('required') && (listingForm.get('address')?.dirty || listingForm.get('address')?.touched)">
        <small>Full address is required.</small>
      </div>
    </div>


		<section class="radio-section">
			<h3 class="section-title required">Available For</h3>
			<div class="radio-group">
				<label class="radio-item"><input type="radio" value="Monthly" formControlName="availableFor" /><span>Monthly Basis</span></label>
				<label class="radio-item"><input type="radio" value="Yearly" formControlName="availableFor" /><span>Yearly Basis</span></label>
			</div>
		</section>

		<section class="radio-section">
			<h3 class="section-title required">Furnishing Type</h3>
			<div class="radio-group">
				<label class="radio-item"><input type="radio" value="Fully furnished" formControlName="furnishing" /><span>Fully furnished</span></label>
				<label class="radio-item"><input type="radio" value="Semi furnished" formControlName="furnishing" /><span>Semi furnished</span></label>
				<label class="radio-item"><input type="radio" value="Unfurnished" formControlName="furnishing" /><span>Unfurnished</span></label>
			</div>
		</section>

		<section class="radio-section">
			<h3 class="section-title required">Accommodation Type</h3>
			<div class="radio-group">
				<label class="radio-item"><input type="radio" value="Independent" formControlName="accommodation" /><span>Independent</span></label>
				<label class="radio-item"><input type="radio" value="Apartment" formControlName="accommodation" /><span>Apartment</span></label>
				<label class="radio-item"><input type="radio" value="Builder Floor" formControlName="accommodation" /><span>Builder Floor</span></label>
			</div>
		</section>

		<section class="radio-section">
			<h3 class="section-title">Pets Allowed</h3>
			<div class="radio-group">
				<label class="radio-item"><input type="radio" value="Yes" formControlName="petAllowed" /><span>Yes</span></label>
				<label class="radio-item"><input type="radio" value="No" formControlName="petAllowed" /><span>No</span></label>
			</div>
		</section>

		<section class="radio-section">
			<h3 class="section-title required">Gender Preferences</h3>
			<div class="radio-group">
				<label class="radio-item"><input type="radio" value="Male" formControlName="gender" /><span>Male</span></label>
				<label class="radio-item"><input type="radio" value="Female" formControlName="gender" /><span>Female</span></label>
				<label class="radio-item"><input type="radio" value="Both M &amp; F" formControlName="gender" /><span>Both M &amp; F</span></label>
				<label class="radio-item"><input type="radio" value="Any" formControlName="gender" /><span>Any</span></label>
			</div>
		</section>

		<section class="radio-section">
			<h3 class="section-title required">Room Type</h3>
			<div class="radio-group">
				<label class="radio-item"><input type="radio" value="Private" formControlName="roomType" /><span>Private</span></label>
				<label class="radio-item"><input type="radio" value="Shared" formControlName="roomType" /><span>Shared</span></label>
			</div>
		</section>

		<section class="radio-section" formGroupName="parking">
			<h3 class="section-title">Parking</h3>
			<div class="radio-group">
				<label class="radio-item"><input type="checkbox" formControlName="car" /><span>Car</span></label>
				<label class="radio-item"><input type="checkbox" formControlName="bike" /><span>Bike</span></label>
			</div>
		</section>

		<section class="radio-section" formGroupName="preferTenant">
			<h3 class="section-title">Prefer Tenant Type</h3>
			<div class="radio-group">
				<label class="radio-item"><input type="checkbox" formControlName="family" /><span>Family</span></label>
				<label class="radio-item"><input type="checkbox" formControlName="bachelors" /><span>Bachelors</span></label>
				<label class="radio-item"><input type="checkbox" formControlName="girls" /><span>Girls</span></label>
				<label class="radio-item"><input type="checkbox" formControlName="boys" /><span>Boys</span></label>
				<label class="radio-item"><input type="checkbox" formControlName="professionals" /><span>Professionals</span></label>
			</div>
		</section>

		<section class="radio-section" formGroupName="insideFacility">
			<h3 class="section-title required">Room Inside Facility</h3>
			<div class="radio-group">
				<label class="radio-item" *ngFor="let facility of insideFacilities">
					<input type="checkbox" [formControlName]="facility.key" />
					<span>{{ facility.label }}</span>
				</label>
			</div>
		</section>

		<section class="radio-section" formGroupName="outsideFacility">
			<h3 class="section-title required">Room Outside Facility</h3>
			<div class="radio-group">
				<label class="radio-item" *ngFor="let facility of outsideFacilities">
					<input type="checkbox" [formControlName]="facility.key" />
					<span>{{ facility.label }}</span>
				</label>
			</div>
		</section>

		<section class="button-group">
			<button type="button" class="btn btn-next" (click)="onNext()" [disabled]="listingForm.invalid || !isOtpVerified()">Next</button>
			<button type="button" class="btn btn-cancel" (click)="onCancel()">Cancel</button>
		</section>

		<div *ngIf="showCancelConfirmation" class="cancel-toast">
			<span>Do you really want to cancel submission of this form?</span>
			<div class="toast-actions">
				<button type="button" class="toast-btn" (click)="confirmCancel()">Yes</button>
				<button type="button" class="toast-btn ghost" (click)="dismissCancelConfirmation()">No</button>
			</div>
		</div>

		<div *ngIf="showOtpDialog" class="token-dialog-backdrop">
			<div class="token-dialog">
				<h2>www.roomlocus.com says</h2>
				<p>{{ otpDialogMessage }}</p>
				<button type="button" class="token-dialog-btn" (click)="closeOtpDialog()">OK</button>
			</div>
		</div>
	</form>
</div>
